"use strict";var __extends=this&&this.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),__assign=this&&this.__assign||function(){return __assign=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},__assign.apply(this,arguments)},__awaiter=this&&this.__awaiter||function(t,e,r,n){return new(r||(r=Promise))((function(i,o){function s(t){try{a(n.next(t))}catch(t){o(t)}}function u(t){try{a(n.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,u)}a((n=n.apply(t,e||[])).next())}))},__generator=this&&this.__generator||function(t,e){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(u){return function(a){return function(u){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,u[0]&&(s=0)),s;)try{if(r=1,n&&(i=2&u[0]?n.return:u[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,u[1])).done)return i;switch(n=0,i&&(u=[2&u[0],i.value]),u[0]){case 0:case 1:i=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,n=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==u[0]&&2!==u[0])){s=0;continue}if(3===u[0]&&(!i||u[1]>i[0]&&u[1]<i[3])){s.label=u[1];break}if(6===u[0]&&s.label<i[1]){s.label=i[1],i=u;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(u);break}i[2]&&s.ops.pop(),s.trys.pop();continue}u=e.call(t,s)}catch(t){u=[6,t],n=0}finally{r=i=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,a])}}};function encodeServerKey(t){for(var e=(t+"=".repeat((4-t.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),r=window.atob(e),n=new Uint8Array(r.length),i=0;i<r.length;++i)n[i]=r.charCodeAt(i);return n}Object.defineProperty(exports,"__esModule",{value:!0}),exports.WebPushClientFactory=exports.WebPushClient=void 0;var WebPushUtils={checkPermission:function(){return Notification.requestPermission()},registerServiceWorker:function(t){return navigator.serviceWorker.register(t)},getSubscription:function(t){return t.pushManager.getSubscription()}},RemoteStorage=function(){function t(t){this.url=t,this.url=t}return t.prototype.register=function(t,e,r){return void 0===e&&(e={}),void 0===r&&(r={}),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4,fetch(this.url,{method:"POST",mode:"cors",credentials:"include",cache:"default",headers:new Headers(__assign({Accept:"application/json","Content-Type":"application/json"},r)),body:JSON.stringify({subscription:t,options:e})})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.updateOptions=function(t,e,r){return void 0===e&&(e={}),void 0===r&&(r={}),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4,fetch(this.url,{method:"PUT",mode:"cors",credentials:"include",cache:"default",headers:new Headers(__assign({Accept:"application/json","Content-Type":"application/json"},r)),body:JSON.stringify({subscription:t,options:e})})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.unregister=function(t,e){return void 0===e&&(e={}),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(r){switch(r.label){case 0:return[4,fetch(this.url,{method:"DELETE",mode:"cors",credentials:"include",cache:"default",headers:new Headers(__assign({Accept:"application/json","Content-Type":"application/json"},e)),body:JSON.stringify({subscription:t})})];case 1:return r.sent(),[2,!0]}}))}))},t.prototype.ping=function(t,e){return void 0===e&&(e={}),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(r){switch(r.label){case 0:return[4,fetch(this.url,{method:"PING",mode:"cors",credentials:"include",cache:"default",headers:new Headers({Accept:"application/json","Content-Type":"application/json"}),body:JSON.stringify({subscription:t,options:e})})];case 1:return r.sent(),[2,!0]}}))}))},t}(),PushNotificationsNotSupported=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(Error),CreateClientError=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(Error),WebPushClient=function(){function t(t){var e=t.isSupported,r=t.permissionStatus,n=t.serviceWorkerRegistration,i=t.subscription,o=t.applicationServerKey,s=t.subscribeUrl;this.supported=e,this.permissionStatus=r,this.registration=n,this.applicationServerKey=o,this.subscription=i,this.storage=void 0!==s?new RemoteStorage(s):null}return t.prototype.isSupported=function(){return this.supported},t.prototype.ensureSupported=function(){if(!this.isSupported())throw Error("This browser does not support push notifications.")},t.prototype.ensureUrlIsProvided=function(){if(!this.storage)throw Error("Webpush client error: subscribeUrl has not been provided.");return!0},t.prototype.isUrlProvided=function(){return!!this.storage},t.prototype.getPermissionState=function(){return this.ensureSupported(),this.permissionStatus},t.prototype.getSubscription=function(){return this.subscription},t.prototype.subscribe=function(t,e,r){return void 0===t&&(t={}),void 0===e&&(e=this.isUrlProvided()),void 0===r&&(r={}),__awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(i){switch(i.label){case 0:return this.ensureSupported(),[4,this.registration.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.applicationServerKey})];case 1:return n=i.sent(),this.subscription=n,[2,!0===e&&this.ensureUrlIsProvided()&&this.storage?this.storage.register(n,t,r):new Promise((function(t){return t(PushSubscription)}))]}}))}))},t.prototype.unsubscribe=function(t,e){return void 0===t&&(t=this.isUrlProvided()),void 0===e&&(e={}),__awaiter(this,void 0,void 0,(function(){var r;return __generator(this,(function(n){switch(n.label){case 0:return this.ensureSupported(),[4,WebPushUtils.getSubscription(this.registration)];case 1:return(r=n.sent())?[4,r.unsubscribe()]:[2];case 2:return n.sent(),this.subscription=null,[2,!0===t&&this.ensureUrlIsProvided()&&this.storage?this.storage.unregister(r,e):new Promise((function(t){return t(!0)}))]}}))}))},t.prototype.updateOptions=function(t,e){if(void 0===t&&(t={}),void 0===e&&(e={}),this.ensureSupported(),this.ensureUrlIsProvided(),this.storage&&this.subscription)return this.storage.updateOptions(this.subscription,t,e)},t.prototype.ping=function(t){if(void 0===t&&(t={}),this.ensureSupported(),this.ensureUrlIsProvided(),this.storage&&this.subscription)return this.storage.ping(this.subscription,t)},t}();exports.WebPushClient=WebPushClient,exports.WebPushClientFactory={isSupported:function(){return"PushManager"in window&&"fetch"in window&&"permissions"in navigator&&"serviceWorker"in navigator},create:function(t){var e=t.serviceWorkerPath,r=t.subscribeUrl,n=t.serverKey;return __awaiter(this,void 0,void 0,(function(){var t,i,o,s;return __generator(this,(function(u){switch(u.label){case 0:if(!this.isSupported())throw new PushNotificationsNotSupported;u.label=1;case 1:return u.trys.push([1,5,,6]),[4,WebPushUtils.checkPermission()];case 2:return t=u.sent(),[4,WebPushUtils.registerServiceWorker(e)];case 3:return i=u.sent(),[4,WebPushUtils.getSubscription(i)];case 4:return o=u.sent(),[2,new WebPushClient({isSupported:!0,applicationServerKey:encodeServerKey(n),permissionStatus:t,serviceWorkerRegistration:i,subscription:o,subscribeUrl:r})];case 5:throw s=u.sent(),console.warn("Webpush client cannot be started: "+s),new CreateClientError(s instanceof Error?s.message:"");case 6:return[2]}}))}))}};