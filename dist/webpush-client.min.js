"use strict";var __extends=this&&this.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),__assign=this&&this.__assign||function(){return __assign=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},__assign.apply(this,arguments)};function encodeServerKey(t){for(var e=(t+"=".repeat((4-t.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),r=window.atob(e),n=new Uint8Array(r.length),i=0;i<r.length;++i)n[i]=r.charCodeAt(i);return n}function required(t){throw void 0===t&&(t=""),new Error("Missing parameter "+t)}Object.defineProperty(exports,"__esModule",{value:!0});var WebPushUtils={checkPermission:function(){return Notification.requestPermission()},registerServiceWorker:function(t){return navigator.serviceWorker.register(t).then((function(t){return t}))},getSubscription:function(t){return t.pushManager.getSubscription()}},RemoteStorage=function(){function t(t){this.url=t,this.url=t}return t.prototype.register=function(t,e,r){return void 0===e&&(e={}),void 0===r&&(r={}),fetch(this.url,{method:"POST",mode:"cors",credentials:"include",cache:"default",headers:new Headers(__assign({Accept:"application/json","Content-Type":"application/json"},r)),body:JSON.stringify({subscription:t,options:e})}).then((function(){return t}))},t.prototype.updateOptions=function(t,e){return void 0===e&&(e={}),fetch(this.url,{method:"PUT",mode:"cors",credentials:"include",cache:"default",headers:new Headers({Accept:"application/json","Content-Type":"application/json"}),body:JSON.stringify({subscription:t,options:e})}).then((function(){return t}))},t.prototype.unregister=function(t){return fetch(this.url,{method:"DELETE",mode:"cors",credentials:"include",cache:"default",headers:new Headers({Accept:"application/json","Content-Type":"application/json"}),body:JSON.stringify({subscription:t})}).then((function(){return!0}))},t.prototype.ping=function(t,e){return void 0===e&&(e={}),fetch(this.url,{method:"PING",mode:"cors",credentials:"include",cache:"default",headers:new Headers({Accept:"application/json","Content-Type":"application/json"}),body:JSON.stringify({subscription:t,options:e})}).then((function(){return!0}))},t}(),PushNotificationsNotSupported=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(Error),CreateClientError=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(Error),WebPushClient=function(){function t(t){var e=t.isSupported,r=t.permissionStatus,n=t.serviceWorkerRegistration,i=t.subscription,o=t.applicationServerKey,s=t.subscribeUrl;this.supported=e,this.permissionStatus=r,this.registration=n,this.applicationServerKey=o,this.subscription=i,this.storage=void 0!==s?new RemoteStorage(s):null}return t.prototype.isSupported=function(){return this.supported},t.prototype.ensureSupported=function(){if(!this.isSupported())throw Error("This browser does not support push notifications.")},t.prototype.ensureUrlIsProvided=function(){if(!this.storage)throw Error("Webpush client error: subscribeUrl has not been provided.");return!0},t.prototype.isUrlProvided=function(){return!!this.storage},t.prototype.getPermissionState=function(){return this.ensureSupported(),this.permissionStatus},t.prototype.getSubscription=function(){return this.subscription},t.prototype.subscribe=function(t,e,r){var n=this;return void 0===t&&(t={}),void 0===e&&(e=this.isUrlProvided()),void 0===r&&(r={}),this.ensureSupported(),this.registration.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.applicationServerKey}).then((function(i){return n.subscription=i,!0===e&&n.ensureUrlIsProvided()&&n.storage?n.storage.register(i,t,r):new Promise((function(t){return t(PushSubscription)}))}))},t.prototype.unsubscribe=function(t){var e=this;return void 0===t&&(t=this.isUrlProvided()),this.ensureSupported(),WebPushUtils.getSubscription(this.registration).then((function(r){r&&r.unsubscribe().then((function(){return e.subscription=null,!0===t&&e.ensureUrlIsProvided()&&e.storage?e.storage.unregister(r):new Promise((function(t){return t(!0)}))}))}))},t.prototype.updateOptions=function(t){if(void 0===t&&(t={}),this.ensureSupported(),this.ensureUrlIsProvided(),this.storage&&this.subscription)return this.storage.updateOptions(this.subscription,t)},t.prototype.ping=function(t){if(void 0===t&&(t={}),this.ensureSupported(),this.ensureUrlIsProvided(),this.storage&&this.subscription)return this.storage.ping(this.subscription,t)},t}(),WebPushClientFactory={isSupported:function(){return"PushManager"in window&&"fetch"in window&&"permissions"in navigator&&"serviceWorker"in navigator},create:function(t){var e=t.serviceWorkerPath,r=t.subscribeUrl,n=t.serverKey;if(!this.isSupported())throw new PushNotificationsNotSupported;return WebPushUtils.checkPermission().then((function(t){return WebPushUtils.registerServiceWorker(e).then((function(e){return WebPushUtils.getSubscription(e).then((function(i){return new WebPushClient({isSupported:!0,applicationServerKey:encodeServerKey(n),permissionStatus:t,serviceWorkerRegistration:e,subscription:i,subscribeUrl:r})}))})).catch((function(t){throw console.warn("Webpush client cannot be started: "+t),new CreateClientError(t.message)}))}))}};exports.default=WebPushClientFactory;